<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Management Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom scrollbar for better aesthetics - Dark Mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-gray-100">Lead Manager</h1>
                <p class="text-sm text-gray-400 mt-1">Business Dashboard</p>
            </div>
            
            <nav class="flex-1 p-4">
                <div class="space-y-2">
                    <button id="showFormBtn" class="w-full flex items-center space-x-3 px-4 py-3 text-left rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus-circle"></i>
                        <span class="font-medium">Add Lead</span>
                    </button>
                    <button id="showBoardBtn" class="w-full flex items-center space-x-3 px-4 py-3 text-left rounded-lg text-gray-300 hover:bg-gray-700 transition-colors">
                        <i class="fas fa-columns"></i>
                        <span class="font-medium">Board View</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-900">
            <!-- Header with Pipeline Value -->
            <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-100">Lead Management</h2>
                        <p class="text-sm text-gray-400">Track and manage your business leads</p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg px-6 py-3 shadow-sm">
                        <p class="text-xs text-blue-100 uppercase tracking-wide mb-1">Pipeline Value</p>
                        <p class="text-2xl font-bold text-white" id="pipelineValue">$0.00</p>
                    </div>
                </div>
            </header>

            <!-- Search Bar -->
            <div class="px-6 py-4 bg-gray-800 border-b border-gray-700">
                <div class="relative max-w-md">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search leads by name..."
                        class="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <!-- Lead Entry Form (Initially Hidden) -->
                <div id="leadFormSection" class="hidden mb-6">
                    <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6 max-w-2xl">
                        <h3 class="text-lg font-semibold text-gray-100 mb-4">Add New Lead</h3>
                        <form id="leadForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="clientName" class="block text-sm font-medium text-gray-300 mb-2">
                                        Client Name *
                                    </label>
                                    <input 
                                        type="text" 
                                        id="clientName" 
                                        required
                                        minlength="2"
                                        maxlength="100"
                                        placeholder="Enter client name"
                                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p id="clientNameError" class="text-xs text-red-400 mt-1 hidden"></p>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
                                        Email *
                                    </label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        required
                                        placeholder="client@example.com"
                                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p id="emailError" class="text-xs text-red-400 mt-1 hidden"></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="leadStatus" class="block text-sm font-medium text-gray-300 mb-2">
                                        Lead Status *
                                    </label>
                                    <select 
                                        id="leadStatus" 
                                        required
                                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Select status</option>
                                        <option value="New">New</option>
                                        <option value="Contacted">Contacted</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                    <p id="leadStatusError" class="text-xs text-red-400 mt-1 hidden"></p>
                                </div>
                                <div>
                                    <label for="estimatedValue" class="block text-sm font-medium text-gray-300 mb-2">
                                        Estimated Value ($) *
                                    </label>
                                    <input 
                                        type="number" 
                                        id="estimatedValue" 
                                        required
                                        step="0.01"
                                        min="0"
                                        max="999999999.99"
                                        placeholder="0.00"
                                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p id="estimatedValueError" class="text-xs text-red-400 mt-1 hidden"></p>
                                </div>
                            </div>
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-300 mb-2">
                                    Notes
                                </label>
                                <textarea 
                                    id="notes" 
                                    rows="3"
                                    maxlength="1000"
                                    placeholder="Add any notes about this lead..."
                                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                ></textarea>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="notesCharCount">0</span>/1000 characters
                                </p>
                                <p id="notesError" class="text-xs text-red-400 mt-1 hidden"></p>
                            </div>
                            <div class="flex space-x-3 pt-2">
                                <button 
                                    type="submit"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                                >
                                    <i class="fas fa-save mr-2"></i>Save Lead
                                </button>
                                <button 
                                    type="button"
                                    id="cancelFormBtn"
                                    class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Status Board -->
                <div id="boardView">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- New Column -->
                        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700">
                            <div class="p-4 border-b border-gray-700 bg-gray-700">
                                <h3 class="font-semibold text-gray-100">New</h3>
                                <p class="text-xs text-gray-400 mt-1" id="newCount">0 leads</p>
                            </div>
                            <div id="newLeads" class="p-4 space-y-3 min-h-[200px] max-h-[600px] overflow-y-auto custom-scrollbar">
                                <p class="text-sm text-gray-500 text-center py-8">No leads in this status</p>
                            </div>
                        </div>

                        <!-- Contacted Column -->
                        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700">
                            <div class="p-4 border-b border-gray-700 bg-gray-700">
                                <h3 class="font-semibold text-gray-100">Contacted</h3>
                                <p class="text-xs text-gray-400 mt-1" id="contactedCount">0 leads</p>
                            </div>
                            <div id="contactedLeads" class="p-4 space-y-3 min-h-[200px] max-h-[600px] overflow-y-auto custom-scrollbar">
                                <p class="text-sm text-gray-500 text-center py-8">No leads in this status</p>
                            </div>
                        </div>

                        <!-- In Progress Column -->
                        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700">
                            <div class="p-4 border-b border-gray-700 bg-gray-700">
                                <h3 class="font-semibold text-gray-100">In Progress</h3>
                                <p class="text-xs text-gray-400 mt-1" id="inProgressCount">0 leads</p>
                            </div>
                            <div id="inProgressLeads" class="p-4 space-y-3 min-h-[200px] max-h-[600px] overflow-y-auto custom-scrollbar">
                                <p class="text-sm text-gray-500 text-center py-8">No leads in this status</p>
                            </div>
                        </div>

                        <!-- Closed Column -->
                        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700">
                            <div class="p-4 border-b border-gray-700 bg-gray-700">
                                <h3 class="font-semibold text-gray-100">Closed</h3>
                                <p class="text-xs text-gray-400 mt-1" id="closedCount">0 leads</p>
                            </div>
                            <div id="closedLeads" class="p-4 space-y-3 min-h-[200px] max-h-[600px] overflow-y-auto custom-scrollbar">
                                <p class="text-sm text-gray-500 text-center py-8">No leads in this status</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // DATA STORAGE & INITIALIZATION
        // ============================================
        
        let leads = [];
        let currentSearchTerm = '';

        // Load leads from Local Storage
        function loadLeads() {
            const storedLeads = localStorage.getItem('leads');
            if (storedLeads) {
                leads = JSON.parse(storedLeads);
                // Migration: Ensure all leads have createdAt timestamp
                let needsSave = false;
                leads.forEach(lead => {
                    if (!lead.createdAt) {
                        // If no createdAt, use a default date (7 days ago to avoid false "Today" badges)
                        lead.createdAt = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                        needsSave = true;
                    }
                });
                if (needsSave) {
                    saveLeads();
                }
            }
            renderBoard();
            updatePipelineValue();
        }

        // Save leads to Local Storage
        function saveLeads() {
            localStorage.setItem('leads', JSON.stringify(leads));
        }

        // ============================================
        // LEAD MANAGEMENT FUNCTIONS
        // ============================================

        function addLead(clientName, email, leadStatus, estimatedValue, notes = '') {
            const lead = {
                id: Date.now(),
                clientName: clientName.trim(),
                email: email.trim(),
                leadStatus: leadStatus,
                estimatedValue: parseFloat(estimatedValue),
                notes: notes.trim(),
                createdAt: new Date().toISOString()
            };
            
            leads.push(lead);
            saveLeads();
            renderBoard();
            updatePipelineValue();
        }

        function updateLeadNotes(leadId, notes) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                lead.notes = notes.trim();
                saveLeads();
                renderBoard();
            }
        }

        function updateLeadStatus(leadId, newStatus) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                lead.leadStatus = newStatus;
                saveLeads();
                renderBoard();
                updatePipelineValue();
            }
        }

        function updateLead(leadId, clientName, email, leadStatus, estimatedValue, notes) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                lead.clientName = clientName.trim();
                lead.email = email.trim();
                lead.leadStatus = leadStatus;
                lead.estimatedValue = parseFloat(estimatedValue);
                lead.notes = notes.trim();
                // Preserve createdAt timestamp - don't update it
                if (!lead.createdAt) {
                    lead.createdAt = new Date().toISOString();
                }
                saveLeads();
                renderBoard();
                updatePipelineValue();
            }
        }

        function deleteLead(leadId) {
            if (confirm('Are you sure you want to delete this lead? This action cannot be undone.')) {
                leads = leads.filter(l => l.id !== leadId);
                saveLeads();
                renderBoard();
                updatePipelineValue();
            }
        }

        // ============================================
        // PIPELINE VALUE CALCULATION
        // ============================================

        function updatePipelineValue() {
            const inProgressLeads = leads.filter(l => l.leadStatus === 'In Progress');
            const totalValue = inProgressLeads.reduce((sum, lead) => sum + lead.estimatedValue, 0);
            document.getElementById('pipelineValue').textContent = `$${totalValue.toFixed(2)}`;
        }

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================

        function filterLeads(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase();
            renderBoard();
        }

        // ============================================
        // DATE COMPARISON FUNCTIONS
        // ============================================

        function getDaysInPipeline(createdAt) {
            if (!createdAt) return 0;
            
            const createdDate = new Date(createdAt);
            const today = new Date();
            
            // Reset time to midnight for accurate day comparison
            today.setHours(0, 0, 0, 0);
            createdDate.setHours(0, 0, 0, 0);
            
            // Calculate difference in milliseconds and convert to days
            const diffTime = today - createdDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        function isToday(createdAt) {
            if (!createdAt) return false;
            
            const createdDate = new Date(createdAt);
            const today = new Date();
            
            return createdDate.getDate() === today.getDate() &&
                   createdDate.getMonth() === today.getMonth() &&
                   createdDate.getFullYear() === today.getFullYear();
        }

        function isOverdue(lead) {
            if (lead.leadStatus !== 'New') return false;
            
            const daysInPipeline = getDaysInPipeline(lead.createdAt);
            return daysInPipeline > 3;
        }

        // ============================================
        // RENDERING FUNCTIONS
        // ============================================

        function renderBoard() {
            // Filter leads based on search term
            const filteredLeads = currentSearchTerm 
                ? leads.filter(lead => lead.clientName.toLowerCase().includes(currentSearchTerm))
                : leads;

            // Group leads by status
            const leadsByStatus = {
                'New': filteredLeads.filter(l => l.leadStatus === 'New'),
                'Contacted': filteredLeads.filter(l => l.leadStatus === 'Contacted'),
                'In Progress': filteredLeads.filter(l => l.leadStatus === 'In Progress'),
                'Closed': filteredLeads.filter(l => l.leadStatus === 'Closed')
            };

            // Render each column
            renderColumn('newLeads', leadsByStatus['New'], 'New');
            renderColumn('contactedLeads', leadsByStatus['Contacted'], 'Contacted');
            renderColumn('inProgressLeads', leadsByStatus['In Progress'], 'In Progress');
            renderColumn('closedLeads', leadsByStatus['Closed'], 'Closed');

            // Update counts
            document.getElementById('newCount').textContent = `${leadsByStatus['New'].length} lead${leadsByStatus['New'].length !== 1 ? 's' : ''}`;
            document.getElementById('contactedCount').textContent = `${leadsByStatus['Contacted'].length} lead${leadsByStatus['Contacted'].length !== 1 ? 's' : ''}`;
            document.getElementById('inProgressCount').textContent = `${leadsByStatus['In Progress'].length} lead${leadsByStatus['In Progress'].length !== 1 ? 's' : ''}`;
            document.getElementById('closedCount').textContent = `${leadsByStatus['Closed'].length} lead${leadsByStatus['Closed'].length !== 1 ? 's' : ''}`;
        }

        function renderColumn(containerId, leadsList, currentStatus) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (leadsList.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No leads in this status</p>';
                return;
            }

            leadsList.forEach(lead => {
                const leadCard = document.createElement('div');
                
                // Apply visual urgency logic
                const daysInPipeline = getDaysInPipeline(lead.createdAt);
                const overdue = isOverdue(lead);
                const today = isToday(lead.createdAt);
                
                // Set background color and border based on urgency
                let cardBgClass = 'bg-gray-700';
                let borderClass = 'border-gray-600';
                if (overdue) {
                    cardBgClass = 'bg-red-50 dark:bg-red-900/20';
                    borderClass = 'border-red-300 dark:border-red-700';
                }
                
                leadCard.className = `${cardBgClass} rounded-lg p-4 border ${borderClass} hover:shadow-md transition-shadow`;
                
                const hasNotes = lead.notes && lead.notes.trim().length > 0;
                const notesPreview = hasNotes ? (lead.notes.length > 50 ? lead.notes.substring(0, 50) + '...' : lead.notes) : '';
                
                // Badge HTML
                let badgeHTML = '';
                if (overdue) {
                    badgeHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"><i class="fas fa-exclamation-circle mr-1"></i>Overdue</span>';
                } else if (today) {
                    badgeHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"><i class="fas fa-check-circle mr-1"></i>Today</span>';
                }
                
                // Set text colors based on background
                const textColorClass = overdue ? 'text-gray-800' : 'text-gray-100';
                const textSecondaryClass = overdue ? 'text-gray-600' : 'text-gray-400';
                const textValueClass = overdue ? 'text-blue-600' : 'text-blue-400';
                const textDaysClass = overdue ? 'text-gray-700' : 'text-gray-500';
                const notesBgClass = overdue ? 'bg-gray-200' : 'bg-gray-600';
                const notesTextClass = overdue ? 'text-gray-800' : 'text-gray-300';
                
                leadCard.innerHTML = `
                    <div class="mb-3">
                        <div class="flex items-start justify-between mb-1">
                            <h4 class="font-semibold ${textColorClass} text-sm flex-1">${escapeHtml(lead.clientName)}</h4>
                            ${badgeHTML}
                        </div>
                        <p class="text-xs ${textSecondaryClass} mb-2">
                            <i class="fas fa-envelope mr-1"></i>${escapeHtml(lead.email)}
                        </p>
                        <p class="text-sm font-semibold ${textValueClass} mb-2">$${lead.estimatedValue.toFixed(2)}</p>
                        <p class="text-xs ${textDaysClass} mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>Days in Pipeline: <span class="font-semibold">${daysInPipeline}</span>
                        </p>
                        ${hasNotes ? `
                            <div class="mt-2 p-2 ${notesBgClass} rounded text-xs ${notesTextClass}">
                                <i class="fas fa-sticky-note mr-1 text-yellow-400"></i>
                                <span>${escapeHtml(notesPreview)}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex flex-col space-y-2">
                        <select 
                            onchange="updateLeadStatus(${lead.id}, this.value)"
                            class="text-xs ${overdue ? 'bg-white border-gray-300 text-gray-800' : 'bg-gray-600 border-gray-500 text-gray-100'} border rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        >
                            <option value="New" ${lead.leadStatus === 'New' ? 'selected' : ''}>New</option>
                            <option value="Contacted" ${lead.leadStatus === 'Contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="In Progress" ${lead.leadStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Closed" ${lead.leadStatus === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                        <div class="flex space-x-2">
                            <button 
                                onclick="openEditLeadModal(${lead.id})"
                                class="flex-1 text-xs bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-2 rounded flex items-center justify-center transition-colors"
                                title="Edit Lead"
                            >
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button 
                                onclick="deleteLead(${lead.id})"
                                class="flex-1 text-xs bg-red-600 hover:bg-red-700 text-white font-medium py-1.5 px-2 rounded flex items-center justify-center transition-colors"
                                title="Delete Lead"
                            >
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                        <button 
                            onclick="openNotesModal(${lead.id})"
                            class="text-xs text-yellow-400 hover:text-yellow-300 hover:underline text-left flex items-center"
                        >
                            <i class="fas fa-sticky-note mr-1"></i>${hasNotes ? 'Edit Notes' : 'Add Notes'}
                        </button>
                    </div>
                `;
                
                container.appendChild(leadCard);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // UI TOGGLE FUNCTIONS
        // ============================================

        function showForm() {
            document.getElementById('leadFormSection').classList.remove('hidden');
            document.getElementById('boardView').classList.add('hidden');
            document.getElementById('showFormBtn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('showFormBtn').classList.remove('text-gray-300');
            document.getElementById('showBoardBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('showBoardBtn').classList.add('text-gray-300');
            // Clear form and errors when showing form
            document.getElementById('leadForm').reset();
            clearAllErrors();
            updateNotesCharCount();
            document.getElementById('clientName').focus();
        }

        function showBoard() {
            document.getElementById('leadFormSection').classList.add('hidden');
            document.getElementById('boardView').classList.remove('hidden');
            document.getElementById('showBoardBtn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('showBoardBtn').classList.remove('text-gray-300');
            document.getElementById('showFormBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('showFormBtn').classList.add('text-gray-300');
        }

        // ============================================
        // FORM VALIDATION FUNCTIONS
        // ============================================

        function validateClientName() {
            const clientName = document.getElementById('clientName');
            const clientNameValue = clientName.value.trim();
            const errorElement = document.getElementById('clientNameError');
            
            if (!clientNameValue) {
                showError(clientName, errorElement, 'Client name is required');
                return false;
            }
            
            if (clientNameValue.length < 2) {
                showError(clientName, errorElement, 'Client name must be at least 2 characters');
                return false;
            }
            
            if (clientNameValue.length > 100) {
                showError(clientName, errorElement, 'Client name must be less than 100 characters');
                return false;
            }
            
            clearError(clientName, errorElement);
            return true;
        }

        function validateEmail() {
            const email = document.getElementById('email');
            const emailValue = email.value.trim();
            const errorElement = document.getElementById('emailError');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailValue) {
                showError(email, errorElement, 'Email is required');
                return false;
            }
            
            if (!emailRegex.test(emailValue)) {
                showError(email, errorElement, 'Please enter a valid email address');
                return false;
            }
            
            clearError(email, errorElement);
            return true;
        }

        function validateLeadStatus() {
            const leadStatus = document.getElementById('leadStatus');
            const leadStatusValue = leadStatus.value;
            const errorElement = document.getElementById('leadStatusError');
            
            if (!leadStatusValue) {
                showError(leadStatus, errorElement, 'Please select a lead status');
                return false;
            }
            
            clearError(leadStatus, errorElement);
            return true;
        }

        function validateEstimatedValue() {
            const estimatedValue = document.getElementById('estimatedValue');
            const estimatedValueInput = estimatedValue.value.trim();
            const errorElement = document.getElementById('estimatedValueError');
            
            if (!estimatedValueInput) {
                showError(estimatedValue, errorElement, 'Estimated value is required');
                return false;
            }
            
            const value = parseFloat(estimatedValueInput);
            
            if (isNaN(value)) {
                showError(estimatedValue, errorElement, 'Estimated value must be a valid number');
                return false;
            }
            
            if (value < 0) {
                showError(estimatedValue, errorElement, 'Estimated value cannot be negative');
                return false;
            }
            
            if (value > 999999999.99) {
                showError(estimatedValue, errorElement, 'Estimated value is too large');
                return false;
            }
            
            clearError(estimatedValue, errorElement);
            return true;
        }

        function validateNotes() {
            const notes = document.getElementById('notes');
            const notesValue = notes.value.trim();
            const errorElement = document.getElementById('notesError');
            
            if (notesValue.length > 1000) {
                showError(notes, errorElement, 'Notes cannot exceed 1000 characters');
                return false;
            }
            
            clearError(notes, errorElement);
            return true;
        }

        function showError(inputElement, errorElement, message) {
            inputElement.classList.remove('border-gray-600');
            inputElement.classList.add('border-red-500');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function clearError(inputElement, errorElement) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-600');
            errorElement.classList.add('hidden');
        }

        function validateForm() {
            const isValid = 
                validateClientName() &&
                validateEmail() &&
                validateLeadStatus() &&
                validateEstimatedValue() &&
                validateNotes();
            
            return isValid;
        }

        function clearAllErrors() {
            const inputs = ['clientName', 'email', 'leadStatus', 'estimatedValue', 'notes'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const errorElement = document.getElementById(inputId + 'Error');
                if (input && errorElement) {
                    clearError(input, errorElement);
                }
            });
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Form submission
        document.getElementById('leadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate all fields
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            const clientName = document.getElementById('clientName').value.trim();
            const email = document.getElementById('email').value.trim();
            const leadStatus = document.getElementById('leadStatus').value;
            const estimatedValue = document.getElementById('estimatedValue').value;
            const notes = document.getElementById('notes').value.trim();

            addLead(clientName, email, leadStatus, estimatedValue, notes);
            
            // Reset form and clear errors
            document.getElementById('leadForm').reset();
            clearAllErrors();
            updateNotesCharCount();
            
            // Show board view
            showBoard();
        });

        // Real-time validation on input/blur
        document.getElementById('clientName').addEventListener('blur', validateClientName);
        document.getElementById('clientName').addEventListener('input', function() {
            if (this.classList.contains('border-red-500')) {
                validateClientName();
            }
        });

        document.getElementById('email').addEventListener('blur', validateEmail);
        document.getElementById('email').addEventListener('input', function() {
            if (this.classList.contains('border-red-500')) {
                validateEmail();
            }
        });

        document.getElementById('leadStatus').addEventListener('change', validateLeadStatus);

        document.getElementById('estimatedValue').addEventListener('blur', validateEstimatedValue);
        document.getElementById('estimatedValue').addEventListener('input', function() {
            if (this.classList.contains('border-red-500')) {
                validateEstimatedValue();
            }
        });

        // Notes character counter
        function updateNotesCharCount() {
            const notes = document.getElementById('notes');
            const charCount = document.getElementById('notesCharCount');
            if (notes && charCount) {
                charCount.textContent = notes.value.length;
            }
        }

        document.getElementById('notes').addEventListener('input', function() {
            updateNotesCharCount();
            if (this.classList.contains('border-red-500')) {
                validateNotes();
            }
        });

        // Cancel form button
        document.getElementById('cancelFormBtn').addEventListener('click', showBoard);

        // Navigation buttons
        document.getElementById('showFormBtn').addEventListener('click', showForm);
        document.getElementById('showBoardBtn').addEventListener('click', showBoard);

        // Search input
        document.getElementById('searchInput').addEventListener('input', function(event) {
            filterLeads(event.target.value);
        });

        // ============================================
        // NOTES MODAL FUNCTIONS
        // ============================================

        function openNotesModal(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'notesModalOverlay';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    closeNotesModal();
                }
            };

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-800 rounded-lg shadow-xl border border-gray-700 p-6 max-w-lg w-full mx-4';
            modalContent.onclick = function(e) {
                e.stopPropagation();
            };

            modalContent.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-100">
                        <i class="fas fa-sticky-note mr-2 text-yellow-400"></i>Notes for ${escapeHtml(lead.clientName)}
                    </h3>
                    <button onclick="closeNotesModal()" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <textarea 
                    id="notesTextarea" 
                    rows="6"
                    placeholder="Add notes about this lead..."
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mb-4"
                >${escapeHtml(lead.notes || '')}</textarea>
                <div class="flex space-x-3">
                    <button 
                        onclick="saveNotes(${leadId})"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <i class="fas fa-save mr-2"></i>Save Notes
                    </button>
                    <button 
                        onclick="closeNotesModal()"
                        class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500"
                    >
                        Cancel
                    </button>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Focus on textarea
            setTimeout(() => {
                document.getElementById('notesTextarea').focus();
            }, 100);
        }

        function closeNotesModal() {
            const modal = document.getElementById('notesModalOverlay');
            if (modal) {
                modal.remove();
            }
        }

        function saveNotes(leadId) {
            const notesTextarea = document.getElementById('notesTextarea');
            if (notesTextarea) {
                updateLeadNotes(leadId, notesTextarea.value);
                closeNotesModal();
            }
        }

        // ============================================
        // EDIT LEAD MODAL FUNCTIONS
        // ============================================

        function openEditLeadModal(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'editLeadModalOverlay';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-8';
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    closeEditLeadModal();
                }
            };

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-800 rounded-lg shadow-xl border border-gray-700 p-6 max-w-2xl w-full mx-4 my-8';
            modalContent.onclick = function(e) {
                e.stopPropagation();
            };

            modalContent.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-100">
                        <i class="fas fa-edit mr-2 text-blue-400"></i>Edit Lead
                    </h3>
                    <button onclick="closeEditLeadModal()" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editLeadForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editClientName" class="block text-sm font-medium text-gray-300 mb-2">
                                Client Name *
                            </label>
                            <input 
                                type="text" 
                                id="editClientName" 
                                required
                                minlength="2"
                                maxlength="100"
                                value="${escapeHtml(lead.clientName)}"
                                placeholder="Enter client name"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <p id="editClientNameError" class="text-xs text-red-400 mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="editEmail" class="block text-sm font-medium text-gray-300 mb-2">
                                Email *
                            </label>
                            <input 
                                type="email" 
                                id="editEmail" 
                                required
                                value="${escapeHtml(lead.email)}"
                                placeholder="client@example.com"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <p id="editEmailError" class="text-xs text-red-400 mt-1 hidden"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editLeadStatus" class="block text-sm font-medium text-gray-300 mb-2">
                                Lead Status *
                            </label>
                            <select 
                                id="editLeadStatus" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Select status</option>
                                <option value="New" ${lead.leadStatus === 'New' ? 'selected' : ''}>New</option>
                                <option value="Contacted" ${lead.leadStatus === 'Contacted' ? 'selected' : ''}>Contacted</option>
                                <option value="In Progress" ${lead.leadStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Closed" ${lead.leadStatus === 'Closed' ? 'selected' : ''}>Closed</option>
                            </select>
                            <p id="editLeadStatusError" class="text-xs text-red-400 mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="editEstimatedValue" class="block text-sm font-medium text-gray-300 mb-2">
                                Estimated Value ($) *
                            </label>
                            <input 
                                type="number" 
                                id="editEstimatedValue" 
                                required
                                step="0.01"
                                min="0"
                                max="999999999.99"
                                value="${lead.estimatedValue}"
                                placeholder="0.00"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <p id="editEstimatedValueError" class="text-xs text-red-400 mt-1 hidden"></p>
                        </div>
                    </div>
                    <div>
                        <label for="editNotes" class="block text-sm font-medium text-gray-300 mb-2">
                            Notes
                        </label>
                        <textarea 
                            id="editNotes" 
                            rows="3"
                            maxlength="1000"
                            placeholder="Add any notes about this lead..."
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        >${escapeHtml(lead.notes || '')}</textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            <span id="editNotesCharCount">${(lead.notes || '').length}</span>/1000 characters
                        </p>
                        <p id="editNotesError" class="text-xs text-red-400 mt-1 hidden"></p>
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button 
                            type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                        >
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button 
                            type="button"
                            onclick="closeEditLeadModal()"
                            class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Add event listeners for edit form
            const editForm = document.getElementById('editLeadForm');
            editForm.addEventListener('submit', function(event) {
                event.preventDefault();
                saveEditLead(leadId);
            });

            // Notes character counter for edit form
            const editNotes = document.getElementById('editNotes');
            const editNotesCharCount = document.getElementById('editNotesCharCount');
            editNotes.addEventListener('input', function() {
                editNotesCharCount.textContent = this.value.length;
            });

            // Focus on first input
            setTimeout(() => {
                document.getElementById('editClientName').focus();
            }, 100);
        }

        function closeEditLeadModal() {
            const modal = document.getElementById('editLeadModalOverlay');
            if (modal) {
                modal.remove();
            }
        }

        function saveEditLead(leadId) {
            const clientName = document.getElementById('editClientName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const leadStatus = document.getElementById('editLeadStatus').value;
            const estimatedValue = document.getElementById('editEstimatedValue').value;
            const notes = document.getElementById('editNotes').value.trim();

            // Basic validation
            if (!clientName || !email || !leadStatus || !estimatedValue) {
                alert('Please fill in all required fields!');
                return;
            }

            if (clientName.length < 2 || clientName.length > 100) {
                alert('Client name must be between 2 and 100 characters');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            const value = parseFloat(estimatedValue);
            if (isNaN(value) || value < 0 || value > 999999999.99) {
                alert('Please enter a valid estimated value');
                return;
            }

            if (notes.length > 1000) {
                alert('Notes cannot exceed 1000 characters');
                return;
            }

            updateLead(leadId, clientName, email, leadStatus, estimatedValue, notes);
            closeEditLeadModal();
        }

        // Make functions globally available for inline event handlers
        window.updateLeadStatus = updateLeadStatus;
        window.deleteLead = deleteLead;
        window.openNotesModal = openNotesModal;
        window.closeNotesModal = closeNotesModal;
        window.saveNotes = saveNotes;
        window.openEditLeadModal = openEditLeadModal;
        window.closeEditLeadModal = closeEditLeadModal;

        // ============================================
        // INITIALIZATION
        // ============================================

        // Load leads when page loads
        loadLeads();
        
        // Initialize notes character counter
        updateNotesCharCount();
        
        // Show board view by default
        showBoard();
    </script>
</body>
</html>
